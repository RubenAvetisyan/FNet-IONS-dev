SELECT 
	MAIN.contractNumber, 
  MAIN.Контрагент,
  group_concat(DISTINCT MAIN.tariff) as tariff,
  MAIN.connection_date,
  group_concat(DISTINCT MAIN.price) as price,
  MAIN.balance, 
  MAIN.pay_dt_by_tariff, 
  MAIN.last_pay_dt,
  MAIN.summa,
  CASE
		WHEN find_in_set(group_concat(MAIN.status), 'վճարված չէ') > 0 THEN 'Պասիվ'
    WHEN find_in_set(group_concat(MAIN.status), 'Ակտիվ') > 0 AND find_in_set(group_concat(MAIN.status), 'վճարված չէ') = 0 THEN 'Ակտիվ'
    ELSE MAIN.status
  END as status,
  MAIN.address
FROM (SELECT DISTINCT
		c.date1 as connection_date,
    LEFT(contract.title, 7) AS contractNumber,
    PARAMS.contractName as 'Контрагент',
    if(contract.status = 3, null, ifnull(CTL.title, CT.title)) AS tariff,
		CASE WHEN locate('%', tariff_option.title) > 0 AND (CTO.time_to is null OR date(CTO.time_to) > now()) THEN CT.cost - tariff_option.title/100 * CT.cost
			 WHEN locate('-', tariff_option.title) > 0 THEN SUBSTRING_INDEX(SUBSTRING_INDEX(tariff_option.title, '-', -1), ' ', 1)
       WHEN CTL.title IS NOT NULL THEN REPLACE(SUBSTRING_INDEX(SUBSTRING_INDEX(CTL.config, 'cost=', -1), '\n', 1), ',', '')
			 ELSE CT.cost
		END as price,
		ifnull(cb.balance, 0) AS balance,
    SUBSTRING_INDEX(SUBSTRING_INDEX(CG.title, '-', -1), ' ', -1) as pay_dt_by_tariff,
    coalesce(CP.dt, 'платежи отсутствуют') as last_pay_dt,
    CP.summa as summa,
		CASE
			WHEN contract.status = 0 THEN 'Ակտիվ'
			WHEN contract.status = 2 THEN 'անջատված'
			WHEN contract.status = 3 THEN 'փակ'
			WHEN contract.status = 4 THEN 'կասեցված'
			WHEN contract.status = 6 THEN 'միացված չէ'
			WHEN contract.status = 7 THEN 'վճարված չէ'
		END as status,
    concat(
			PARAMS.city, ', ',
			PARAMS.quarter, ', ',
			PARAMS.street, ', ',
			CONCAT(PARAMS.house, PARAMS.frac, ' ', PARAMS.comment),
			if(isnull(PARAMS.flat) OR length(PARAMS.flat) = 0, '', CONCAT(', բն.. ', PARAMS.flat)),
			if(isnull(PARAMS.room) OR length(PARAMS.room) = 0, '', CONCAT(', սենյակ ', PARAMS.room)),
			if(isnull(PARAMS.pod) OR PARAMS.pod < 1 , '', CONCAT(', մուտք. ', PARAMS.pod)),
			if(isnull(PARAMS.floor) OR (PARAMS.flat >=0 AND PARAMS.floor < 1), '', CONCAT(', հարկ. ', PARAMS.floor))
    ) as address
FROM
    billing.contract
    LEFT JOIN (select LEFT(contract.title, 7) as title, max(contract.date1) as date1 from contract group by LEFT(contract.title, 7)) as c ON LEFT(c.title, 7) = LEFT(contract.title, 7)
    LEFT JOIN contract_group AS CG ON contract.gr&(1<<CG.id) > 0
		LEFT JOIN contract_tariff ON contract_tariff.cid = contract.id
    LEFT JOIN (SELECT 
										ct.cid,
										ct.tpid,
										tp.tree_id,
										ct.date1,
										ct.date2,
										tp.title,
										REPLACE(SUBSTRING_INDEX(SUBSTRING_INDEX(tp.config, 'cost=', -1), '\n', 1), ',', '') AS cost
								FROM
										(SELECT *
										 FROM contract_tariff
										 WHERE (date1 IS NULL OR date1 <= CURDATE())
											 AND (date2 IS NULL OR date2 >= CURDATE())) AS ct
								INNER JOIN tariff_plan AS tp ON ct.tpid = tp.id
							) as CT ON CT.cid = contract.id
		LEFT JOIN contract_tree_link AS CTL ON CTL.cid = contract.id
		LEFT JOIN (SELECT cto.id, cto.time_from, cto.time_to, cto.cid, cto.option_id
							FROM contract_tariff_option AS cto
							INNER JOIN (
								SELECT cid, MAX(activated_time) AS max_activated_time
								FROM contract_tariff_option
								GROUP BY cid
							) AS max_cto
							ON cto.cid = max_cto.cid 
							AND cto.deactivated_time is null
							) AS CTO ON CTO.cid = CT.cid
		LEFT JOIN tariff_option ON tariff_option.id = coalesce(CTO.option_id, CTL.cid)
    INNER JOIN (
								SELECT 
										contract.scid,
                    param1.val as contractName,
										CAST(ah.house AS UNSIGNED) AS house,
										ah.frac,
										ah.comment,
										aq.title AS quarter,
										ast.title AS street,
										ac.title AS city,
                    cpt2.flat,
                    cpt2.room,
                    cpt2.pod,
                    cpt2.floor
								FROM
										billing.contract
										INNER JOIN billing.contract_parameter_type_2 cpt2 ON contract.id = cpt2.cid
										INNER JOIN billing.address_house ah ON cpt2.hid = ah.id
										INNER JOIN billing.address_quarter aq ON ah.quarterId = aq.id
										INNER JOIN billing.address_street ast ON ah.streetId = ast.id
										INNER JOIN billing.address_area aa ON ah.areaId = aa.id
										INNER JOIN billing.address_city ac ON aq.cityId = ac.id
                    LEFT JOIN billing.contract_parameter_type_1 AS param1 ON param1.cid = contract.scid AND param1.pid = 13
						) AS PARAMS ON PARAMS.scid = contract.id OR PARAMS.scid = contract.scid
    LEFT JOIN (
								SELECT cb.cid, (cb.summa1 + cb.summa2 - cb.summa3 - cb.summa4) AS balance, CONCAT(MAX(cb.yy), '-', MAX(cb.mm)) AS last_balance_date
								FROM contract_balance cb
								GROUP BY cb.cid
						) AS cb ON cb.cid = coalesce(contract.scid, contract.id)
		LEFT JOIN (
				SELECT MAIN.contractNumber as contractNumber, sum(MAIN.summa) as summa, max(MAIN.dt) as dt FROM (SELECT 
				LEFT(contract.title, 7) as contractNumber,
				contract_payment.summa,
				contract_payment.dt as dt
				FROM billing.contract_payment
				LEFT JOIN contract ON contract.id = contract_payment.cid
				LEFT JOIN contract_payment_types AS PT ON PT.id = contract_payment.pt
				WHERE contract_payment.dt LIKE CONCAT(DATE_FORMAT(NOW(), '%Y-%m'), '%')
				AND PT.id <> 9 AND PT.up <> 9
				GROUP BY contract_payment.comment) AS MAIN
				GROUP BY MAIN.contractNumber
		) AS CP ON CP.contractNumber = LEFT(contract.title, 7)
WHERE
		contract.title IN (9002732,
9002731,
9002730,
9002728,
9002727,
9002726,
9002725,
9002724,
9002723,
9002722,
9002719,
9002718,
9002717,
9002716,
9002715,
9002714,
9002713,
9002712,
9002711,
9002710,
9002709,
9002708,
9002707,
9002706,
9002705,
9002704,
9002703,
9002702,
9002700,
9002699,
9002698,
9002696,
9002695,
9002693,
9002692,
9002691,
9002690,
9002689,
9002688,
9002687,
9002686,
9002685,
9002682,
9002681,
9002679,
9002678,
9002677,
9002674,
9002671,
9002670,
9002669,
9002668,
9002667,
9002666,
9002665,
9002664,
9002663,
9002662,
9002661,
9002660,
9002659,
9002658,
9002657,
9002656,
9002655,
9002654,
9002653,
9002652,
9002650,
9002648,
9002647,
9002646,
9002645,
9002644,
9002643,
9002642,
9002641,
9002640,
9002639,
9002638,
9002637,
9002636,
9002635,
9002634,
9002633,
9002632,
9002631,
9002630,
9002629,
9002627,
9002626,
9002625,
9002624,
9002623,
9002622,
9002621,
9002620,
9002619,
9002618,
9002616,
9002614,
9002613,
9002612,
9002611,
9002610,
9002609,
9002608,
9002607,
9002606,
9002605,
9002604,
9002602,
9002601,
9002600,
9002599,
9002598,
9002597,
9002596,
9002595,
9002594,
9002593,
9002592,
9002591,
9002590,
9002589,
9002588,
9002587,
9002586,
9002585,
9002584,
9002583,
9002581,
9002580,
9002579,
9002578,
9002577,
9002576,
9002574,
9002573,
9002572,
9002571,
9002570,
9002569,
9002568,
9002567,
9002566,
9002565,
9002564,
9002563,
9002561,
9002560,
9002557,
9002556,
9002555,
9002554,
9002553,
9002552,
9002551,
9002550,
9002549,
9002548,
9002547,
9002546,
9002545,
9002543,
9002542,
9002541,
9002540,
9002539,
9002538,
9002537,
9002536,
9002535,
9002534,
9002532,
9002531,
9002530,
9002529,
9002528,
9002527,
9002525,
9002524,
9002523,
9002522,
9002521,
9002520,
9002518,
9002517,
9002515,
9002514,
9002513,
9002512,
9002511,
9002510,
9002509,
9002508,
9002507,
9002506,
9002505,
9002504,
9002503,
9002502,
9002501,
9002500,
9002499,
9002498,
9002497,
9002496,
9002495,
9002494,
9002492,
9002491,
9002490,
9002489,
9002488,
9002487,
9002486,
9002485,
9002484,
9002483,
9002482,
9002481,
9002480,
9002479,
9002478,
9002477,
9002476,
9002475,
9002474,
9002473,
9002472,
9002471,
9002470,
9002469,
9002468,
9002466,
9002465,
9002464,
9002463,
9002462,
9002461,
9002460,
9002459,
9002457,
9002456,
9002455,
9002454,
9002453,
9002452,
9002451,
9002450,
9002449,
9002448,
9002447,
9002446,
9002445,
9002444,
9002443,
9002442,
9002441,
9002440,
9002439,
9002438,
9002437,
9002436,
9002435,
9002434,
9002433,
9002432,
9002431,
9002430,
9002429,
9002428,
9002427,
9002426,
9002425,
9002423,
9002422,
9002421,
9002420,
9002419,
9002418,
9002417,
9002416,
9002415,
9002414,
9002413,
9002412,
9002410,
9002409,
9002408,
9002407,
9002405,
9002404,
9002403,
9002402,
9002401,
9002400,
9002399,
9002398,
9002397,
9002396,
9002395,
9002393,
9002392,
9002391,
9002390,
9002389,
9002388,
9002387,
9002385,
9002384,
9002383,
9002382,
9002381,
9002380,
9002379,
9002378,
9002377,
9002376,
9002375,
9002374,
9002373,
9002372,
9002371,
9002370,
9002369,
9002368,
9002367,
9002366,
9002365,
9002364,
9002363,
9002362,
9002361,
9002360,
9002359,
9002358,
9002357,
9002356,
9002355,
9002354,
9002353,
9002352,
9002351,
9002350,
9002349,
9002347,
9002346,
9002345,
9002344,
9002343,
9002342,
9002341,
9002340,
9002339,
9002338,
9002337,
9002336,
9002335,
9002334,
9002333,
9002332,
9002330,
9002329,
9002328,
9002326,
9002325,
9002324,
9002322,
9002321,
9002320,
9002319,
9002318,
9002317,
9002316,
9002315,
9002314,
9002313,
9002312,
9002311,
9002310,
9002309,
9002308,
9002307,
9002306,
9002305,
9002304,
9002303,
9002302,
9002301,
9002300,
9002299,
9002298,
9002297,
9002296,
9002295,
9002294,
9002293,
9002292,
9002291,
9002290,
9002289,
9002288,
9002287,
9002286,
9002285,
9002284,
9002283,
9002282,
9002281,
9002280,
9002279,
9002278,
9002277,
9002276,
9002275,
9002274,
9002273,
9002272,
9002271,
9002270,
9002269,
9002268,
9002267,
9002266,
9002265,
9002264,
9001971,
9001805,
7039494,
7039317,
7039314,
7039277,
7038249,
7036443,
7036441,
7036438,
7036437,
7036413,
7036411,
7035200,
7034046,
7034043,
7033720,
7032216,
7031519,
7031184,
7029915,
7027475,
7027311,
7024701,
7021777,
7020485,
7019883,
7018997,
7018768,
7017947,
7016969,
7016956,
7016733,
7012317,
7012028,
7010402,
7010101,
7009308,
7008938,
5901606,
5822147,
5804711,
5804704,
5804279,
5803959,
5803534,
5802160,
5801522,
5643124,
5515713,
5510447,
5509855,
5509579,
5508454,
5508450,
5508319,
5508146,
5508095,
5508031,
5507955,
5507947,
5507587,
5507584,
5409668,
5353669,
5304390,
5284113,
5283130,
5112908,
5101815,
5017105,
5012907,
5012874)
group by contract.title, contract.status) AS MAIN
WHERE MAIN.price IS NOT NULL
GROUP BY MAIN.contractNumber
ORDER BY MAIN.contractNumber;